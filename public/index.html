<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TradeEye â€” Chart Scanner</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f0f13">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TradeEye">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:            #0f0f13;
  --card:          #16161d;
  --card2:         #1c1c26;
  --border:        #2a2a3d;
  --blue:          #3b82f6;
  --blue-bright:   #60a5fa;
  --green:         #22c55e;
  --green-bright:  #4ade80;
  --orange:        #f97316;
  --orange-bright: #fb923c;
  --yellow:        #eab308;
  --red:           #ef4444;
  --pink:          #ec4899;
  --purple:        #a855f7;
  --white:         #ffffff;
  --text:          #e2e8f0;
  --muted:         #64748b;
  --muted2:        #475569;
}

html, body { height: 100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  display: flex;
  flex-direction: column;
  height: 100dvh;
  overflow: hidden;
}

/* HEADER */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--card);
  border-bottom: 2px solid var(--blue);
  flex-shrink: 0;
  z-index: 50;
}

.logo { display: flex; align-items: center; gap: 10px; }

.logo-badge {
  background: var(--blue);
  border-radius: 8px;
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}

.logo-name {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px; font-weight: 700;
  color: var(--white); letter-spacing: 2px;
}
.logo-name span { color: var(--blue-bright); }

.status-pill {
  display: flex; align-items: center; gap: 6px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 10px; font-weight: 700;
  letter-spacing: 1.5px; color: var(--muted);
  text-transform: uppercase; white-space: nowrap;
}

.sdot {
  width: 7px; height: 7px;
  border-radius: 50%; background: var(--muted); flex-shrink: 0;
}
.sdot.live { background: var(--green); box-shadow: 0 0 8px var(--green); animation: blink 2s infinite; }
.sdot.scan { background: var(--blue);  box-shadow: 0 0 8px var(--blue);  animation: blink 0.7s infinite; }
.sdot.err  { background: var(--red);   box-shadow: 0 0 8px var(--red); }

@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* APP BODY */
.app-body {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; min-height: 0;
}

/* TAB BAR */
.tab-bar {
  display: flex; background: var(--card);
  border-bottom: 1px solid var(--border); flex-shrink: 0;
}

.tab {
  flex: 1; padding: 12px 8px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 13px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--muted); background: none; border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  -webkit-tap-highlight-color: transparent;
}
.tab.active {
  color: var(--white);
  border-bottom-color: var(--blue);
  background: rgba(59,130,246,0.08);
}

/* PANELS */
.panel {
  display: none; flex: 1; flex-direction: column;
  overflow: hidden; min-height: 0;
}
.panel.active { display: flex; }

/* CAMERA VIEWPORT â€” 16:9 */
.cam-viewport {
  position: relative; background: #06060a;
  overflow: hidden; width: 100%;
  aspect-ratio: 16 / 9; flex-shrink: 0;
}

video {
  width: 100%; height: 100%;
  object-fit: cover; display: block;
}

#previewImg {
  width: 100%; height: 100%;
  object-fit: contain; display: none; background: #06060a;
}

canvas { display: none; }

.cam-idle {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 12px;
  background: #06060a;
}
.cam-idle-icon {
  width: 72px; height: 72px; border-radius: 50%;
  background: var(--card2); border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center; font-size: 30px;
}
.cam-idle p { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

/* Reticle */
.reticle { position: absolute; inset: 24px; pointer-events: none; display: none; }
.reticle.on { display: block; }

.reticle::before, .reticle::after, .rc-br, .rc-bl {
  content: ''; position: absolute;
  width: 26px; height: 26px;
  border-style: solid; border-color: var(--blue-bright);
}
.reticle::before { top:0; left:0;   border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
.reticle::after  { top:0; right:0;  border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
.rc-br { bottom:0; right:0; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }
.rc-bl { bottom:0; left:0;  border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }

.sweep { position: absolute; inset: 0; overflow: hidden; }
.sweep::after {
  content: ''; position: absolute;
  left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--blue-bright), transparent);
  box-shadow: 0 0 12px var(--blue);
  animation: swp 2.5s ease-in-out infinite;
}
@keyframes swp {
  0%  { top:0;    opacity:0; }
  5%  { opacity:1; }
  95% { opacity:1; }
  100%{ top:100%; opacity:0; }
}

/* Auto-capture countdown ring */
.countdown-wrap {
  position: absolute;
  bottom: 16px; left: 50%;
  transform: translateX(-50%);
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  z-index: 5;
}
.countdown-wrap.on { display: flex; }

.countdown-ring {
  position: relative;
  width: 64px; height: 64px;
}

.countdown-ring svg {
  position: absolute; inset: 0;
  transform: rotate(-90deg);
}

.countdown-ring circle {
  fill: none;
  stroke-width: 4;
}

.ring-bg   { stroke: rgba(255,255,255,0.15); }
.ring-fill {
  stroke: var(--green);
  stroke-linecap: round;
  stroke-dasharray: 176;
  stroke-dashoffset: 176;
  transition: stroke-dashoffset 1s linear;
}

.countdown-num {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Rajdhani', sans-serif;
  font-size: 26px; font-weight: 700;
  color: var(--white);
}

.countdown-lbl {
  font-size: 9px; letter-spacing: 2px;
  color: var(--green); text-transform: uppercase;
}

/* Auto toggle button */
.auto-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  cursor: pointer; border: none; transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.auto-btn.off { background: var(--card2); color: var(--muted); border: 1px solid var(--border); }
.auto-btn.on  { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.4); }

/* Analyzing overlay */
.analyzing {
  position: absolute; inset: 0;
  background: rgba(6,6,10,0.9);
  display: none; flex-direction: column;
  align-items: center; justify-content: center; gap: 16px; z-index: 10;
}
.analyzing.on { display: flex; }

.spin-ring {
  width: 56px; height: 56px;
  border: 3px solid var(--card2);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.analyzing-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 20px; font-weight: 700;
  color: var(--blue-bright); letter-spacing: 4px;
}
.analyzing-sub { font-size: 11px; color: var(--muted); letter-spacing: 1px; }

/* Action row */
.cam-actions {
  display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 8px;
  padding: 12px; background: var(--card);
  border-top: 1px solid var(--border); flex-shrink: 0;
}

/* UPLOAD PANEL */
.upload-area {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 14px;
  margin: 16px; border: 2px dashed var(--border);
  border-radius: 16px; cursor: pointer;
  transition: all 0.2s; background: var(--card);
  -webkit-tap-highlight-color: transparent;
}
.upload-area:hover, .upload-area.dragover {
  border-color: var(--blue); background: rgba(59,130,246,0.05);
}
.upload-icon {
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--card2); border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center; font-size: 34px;
}
.upload-area h3 {
  font-family: 'Rajdhani', sans-serif;
  font-size: 20px; font-weight: 700; color: var(--white);
}
.upload-area p { font-size: 11px; color: var(--muted); letter-spacing: 1px; }

#fileInput { display: none; }

.upload-preview-wrap { flex: 1; overflow: hidden; min-height: 0; display: none; }
#uploadPreviewImg {
  width: 100%; height: 100%;
  object-fit: contain; background: #06060a; display: block;
}

/* FORM PANEL */
.form-panel-inner {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; min-height: 0;
}

.form-scroll {
  flex: 1; overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  padding: 12px; display: flex; flex-direction: column; gap: 10px;
}
.form-scroll::-webkit-scrollbar { width: 3px; }
.form-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.sect-head { display: flex; align-items: center; gap: 8px; padding: 2px 0; }
.sect-line { flex: 1; height: 1px; background: var(--border); }
.sect-lbl {
  font-family: 'Rajdhani', sans-serif;
  font-size: 11px; font-weight: 700;
  letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted2);
}

.field { display: flex; flex-direction: column; gap: 5px; }
.field-top { display: flex; align-items: center; justify-content: space-between; }
.field-lbl {
  font-size: 10px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
}

.badge {
  font-size: 9px; font-weight: 700;
  letter-spacing: 1px; padding: 2px 8px; border-radius: 20px;
}
.b-blue   { background: rgba(59,130,246,0.2);  color: #93c5fd; border: 1px solid rgba(59,130,246,0.4); }
.b-yellow { background: rgba(234,179,8,0.2);   color: #fde047; border: 1px solid rgba(234,179,8,0.4); }
.b-green  { background: rgba(34,197,94,0.2);   color: #86efac; border: 1px solid rgba(34,197,94,0.4); }
.b-orange { background: rgba(249,115,22,0.2);  color: #fdba74; border: 1px solid rgba(249,115,22,0.4); }
.b-red    { background: rgba(239,68,68,0.2);   color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
.b-purple { background: rgba(168,85,247,0.2);  color: #d8b4fe; border: 1px solid rgba(168,85,247,0.4); }
.b-pink   { background: rgba(236,72,153,0.2);  color: #f9a8d4; border: 1px solid rgba(236,72,153,0.4); }

.finput {
  background: var(--card2);
  border: 1.5px solid var(--border);
  border-radius: 10px; color: var(--white);
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px; font-weight: 500;
  padding: 13px 14px; outline: none; width: 100%;
  transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
  -webkit-appearance: none;
}
.finput::placeholder { color: var(--muted2); font-size: 13px; }
.finput:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.18);
}
.finput.has-value { color: var(--green-bright); border-color: rgba(34,197,94,0.4); }
.finput.popped { animation: pop 0.55s ease forwards; }
@keyframes pop {
  0%   { background: rgba(34,197,94,0.22); }
  100% { background: var(--card2); }
}

.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.form-footer {
  display: grid; grid-template-columns: 1fr auto; gap: 8px;
  padding: 10px 12px; background: var(--card);
  border-top: 1px solid var(--border); flex-shrink: 0;
}

/* BUTTONS */
.btn {
  padding: 13px 16px; border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  cursor: pointer; border: none; transition: all 0.15s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent; user-select: none;
}
.btn:active:not(:disabled) { transform: scale(0.96); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; }

.btn-blue   { background: var(--blue);   color:#fff; box-shadow: 0 4px 14px rgba(59,130,246,0.4); }
.btn-blue:not(:disabled):hover   { background: var(--blue-bright); }
.btn-green  { background: var(--green);  color:#fff; box-shadow: 0 4px 14px rgba(34,197,94,0.35); }
.btn-green:not(:disabled):hover  { background: var(--green-bright); }
.btn-orange { background: var(--orange); color:#fff; box-shadow: 0 4px 14px rgba(249,115,22,0.35); }
.btn-orange:not(:disabled):hover { background: var(--orange-bright); }
.btn-ghost  { background: var(--card2); color: var(--text); border: 1.5px solid var(--border); }
.btn-ghost:not(:disabled):hover  { border-color: var(--blue); color: var(--blue-bright); }
.btn-danger { background: rgba(239,68,68,0.15); color: var(--red); border: 1.5px solid rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.28); }
.btn-sm  { padding: 11px 14px; font-size: 13px; }
.btn-ico { width: 46px; height: 46px; padding: 0; border-radius: 10px; font-size: 18px; }

/* TOAST */
.toast {
  position: fixed; bottom: 76px; left: 50%;
  transform: translateX(-50%) translateY(14px);
  background: var(--card2); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 10px 20px;
  font-size: 13px; font-weight: 500; color: var(--white);
  opacity: 0; pointer-events: none; transition: all 0.28s ease;
  z-index: 999; white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  max-width: calc(100vw - 32px);
  text-overflow: ellipsis; overflow: hidden;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ CALCULATOR STYLES â”€â”€ */
.calc-card {
  background:#fff; border-radius:20px; padding:20px 16px;
  margin-bottom:14px; box-shadow:0 1px 8px rgba(0,0,0,0.08);
}
.calc-sec {
  font-size:11px; font-weight:800; color:#9ca3af;
  text-transform:uppercase; letter-spacing:2px; margin-bottom:16px;
  font-family:'Rajdhani',sans-serif;
}
.calc-lbl {
  display:block; font-size:11px; font-weight:800; color:#9ca3af;
  text-transform:uppercase; letter-spacing:1.5px; margin-bottom:6px;
  font-family:'Rajdhani',sans-serif;
}
.calc-inp {
  width:100%; padding:13px 14px; font-size:15px; font-weight:700;
  background:#fff; border:2px solid #e5e7eb; border-radius:12px;
  color:#111; outline:none; box-sizing:border-box;
  font-family:'JetBrains Mono',monospace;
  -webkit-appearance:none; appearance:none;
}
.calc-inp:focus { border-color:#3b82f6; }
.price-box {
  border-width:1.5px; border-style:solid; border-radius:14px;
  padding:14px 10px; text-align:center;
}
.tf-pill {
  padding:10px 13px; border-radius:10px; cursor:pointer;
  font-size:13px; font-weight:800; transition:all 0.15s;
  min-width:50px; border:1.5px solid #e5e7eb;
  background:#fff; color:#6b7280; font-family:'Rajdhani',sans-serif;
}
.tf-pill.active {
  border:none; background:#0f172a; color:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.calc-stat {
  background:#f8fafc; border-radius:12px; padding:14px 10px; text-align:center;
}
.preset-btn {
  padding:6px 10px; border-radius:8px; cursor:pointer;
  font-size:11px; font-weight:700; letter-spacing:0.5px;
  border:1px solid #334155; background:#0f172a; color:#94a3b8;
  font-family:'JetBrains Mono',monospace; transition:all 0.15s;
}
.preset-btn:active { background:#1e293b; color:#60a5fa; border-color:#3b82f6; }

/* DESKTOP */
@media (min-width: 768px) {
  html, body { overflow: auto; height: auto; min-height: 100vh; }
  body { height: auto; overflow: auto; }
  .app-body { flex-direction: row; overflow: visible; height: auto; flex: 1; }
  .tab-bar { display: none; }
  .panel { display: flex !important; overflow: hidden; }
  #cameraPanel, #uploadPanel {
    flex: 1.3; border-right: 1px solid var(--border);
    max-height: calc(100vh - 58px);
  }
  #formPanel { width: 380px; flex-shrink: 0; max-height: calc(100vh - 58px); }
  #calcPanel { width: 400px; flex-shrink: 0; max-height: calc(100vh - 58px); }
  .toast { bottom: 24px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-badge">ðŸ“¡</div>
    <div class="logo-name">TRADE<span>EYE</span></div>
  </div>
  <div class="status-pill">
    <div class="sdot" id="sdot"></div>
    <span id="stext">STANDBY</span>
  </div>
</div>

<div class="app-body">

  <!-- TAB BAR (mobile) -->
  <div class="tab-bar">
    <button class="tab active" id="tabCam"  onclick="showPanel('camera')">ðŸ“· Cam</button>
    <button class="tab"        id="tabUp"   onclick="showPanel('upload')">ðŸ–¼ Upload</button>
    <button class="tab"        id="tabForm" onclick="showPanel('form')">ðŸ“‹ Fields</button>
    <button class="tab"        id="tabCalc" onclick="showPanel('calc')">ðŸ§® Calc</button>
  </div>

  <!-- CAMERA PANEL -->
  <div class="panel active" id="cameraPanel" style="overflow-y:auto;">
    <div class="cam-viewport">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <img id="previewImg" alt="">

      <div class="cam-idle" id="camIdle">
        <div class="cam-idle-icon">ðŸ“·</div>
        <p>Tap Start Camera</p>
      </div>

      <div class="reticle" id="reticle">
        <div class="rc-br"></div>
        <div class="rc-bl"></div>
        <div class="sweep"></div>
      </div>

      <div class="analyzing" id="analyzing">
        <div class="spin-ring"></div>
        <div class="analyzing-title">ANALYZING</div>
        <div class="analyzing-sub">AI reading chart dataâ€¦</div>
      </div>

      <!-- Auto-capture countdown -->
      <div class="countdown-wrap" id="countdownWrap">
        <div class="countdown-ring">
          <svg viewBox="0 0 64 64" width="64" height="64">
            <circle class="ring-bg"   cx="32" cy="32" r="28"/>
            <circle class="ring-fill" cx="32" cy="32" r="28" id="ringFill"/>
          </svg>
          <div class="countdown-num" id="countdownNum">5</div>
        </div>
        <div class="countdown-lbl">AUTO SCAN</div>
      </div>
    </div>

    <div class="cam-actions">
      <button class="btn btn-blue" id="camMainBtn" onclick="handleCamBtn()">â–¶ START CAMERA</button>
      <button class="auto-btn off" id="autoBtn" onclick="toggleAuto()">âš¡ AUTO</button>
      <button class="btn btn-green btn-sm" id="scanBtn" onclick="doScan()" disabled>SCAN</button>
      <button class="btn btn-ghost btn-sm" id="freshBtn" onclick="freshStart()" title="Reset">â†º</button>
      <button class="btn btn-danger btn-ico" id="camClearBtn" onclick="clearCamPreview()" style="display:none">âœ•</button>
    </div>
  </div>

  <!-- UPLOAD PANEL -->
  <div class="panel" id="uploadPanel">
    <div class="upload-preview-wrap" id="uploadPreviewWrap">
      <img id="uploadPreviewImg" alt="">
    </div>

    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">ðŸ–¼</div>
      <h3>Drop Chart Here</h3>
      <p>or tap to browse screenshot</p>
    </div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">

    <div class="cam-actions">
      <button class="btn btn-blue" onclick="document.getElementById('fileInput').click()">ðŸ“‚ BROWSE FILE</button>
      <button class="btn btn-green btn-sm" id="uploadScanBtn" onclick="doScan()" disabled>âš¡ SCAN</button>
      <button class="btn btn-danger btn-ico" id="uploadClearBtn" onclick="clearUpload()" style="display:none">âœ•</button>
    </div>
  </div>

  <!-- FORM PANEL -->
  <div class="panel" id="formPanel">
    <div class="form-panel-inner">
      <div class="form-scroll">

        <div class="sect-head">
          <div class="sect-line"></div>
          <div class="sect-lbl">Market</div>
          <div class="sect-line"></div>
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">Trading Pair</span>
            <span class="badge b-blue">PAIR</span>
          </div>
          <input class="finput" id="f_pair" type="text" placeholder="AUDUSD, BTCUSD, EURAUDâ€¦" autocomplete="off">
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">Timeframe</span>
            <span class="badge b-yellow">TF</span>
          </div>
          <input class="finput" id="f_tf" type="text" placeholder="5m Â· 1h Â· 4h Â· Dailyâ€¦" autocomplete="off">
        </div>

        <div class="sect-head">
          <div class="sect-line"></div>
          <div class="sect-lbl">Price Levels</div>
          <div class="sect-line"></div>
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">Entry Price</span>
            <span class="badge b-green">ENTRY</span>
          </div>
          <input class="finput" id="f_entry" type="text" placeholder="Current / close price" inputmode="decimal" autocomplete="off">
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">Wilder SAR</span>
            <span class="badge b-orange">SAR</span>
          </div>
          <input class="finput" id="f_sar" type="text" placeholder="Parabolic SAR value" inputmode="decimal" autocomplete="off">
        </div>

        <div class="sect-head">
          <div class="sect-line"></div>
          <div class="sect-lbl">Indicators</div>
          <div class="sect-line"></div>
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">ATR</span>
            <span class="badge b-purple">AVG TRUE RANGE</span>
          </div>
          <input class="finput" id="f_atr" type="text" placeholder="ATR value" inputmode="decimal" autocomplete="off">
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">ADX</span>
            <span class="badge b-blue">TREND STRENGTH</span>
          </div>
          <input class="finput" id="f_adx" type="text" placeholder="ADX value" inputmode="decimal" autocomplete="off">
        </div>

        <div class="grid2">
          <div class="field">
            <div class="field-top">
              <span class="field-lbl">+DI</span>
              <span class="badge b-green">POS</span>
            </div>
            <input class="finput" id="f_pdi" type="text" placeholder="+DI" inputmode="decimal" autocomplete="off">
          </div>
          <div class="field">
            <div class="field-top">
              <span class="field-lbl">âˆ’DI</span>
              <span class="badge b-red">NEG</span>
            </div>
            <input class="finput" id="f_ndi" type="text" placeholder="âˆ’DI" inputmode="decimal" autocomplete="off">
          </div>
        </div>

        <div class="field">
          <div class="field-top">
            <span class="field-lbl">RSI</span>
            <span class="badge b-pink">RELATIVE STRENGTH</span>
          </div>
          <input class="finput" id="f_rsi" type="text" placeholder="RSI value" inputmode="decimal" autocomplete="off">
        </div>

        <div class="sect-head" style="margin-top:8px;">
          <div class="sect-line"></div>
          <div class="sect-lbl" style="color:#f59e0b;">Extreme Point</div>
          <div class="sect-line"></div>
        </div>

        <div class="field" style="border-color:#f59e0b; background:rgba(245,158,11,0.06);">
          <div class="field-top">
            <span class="field-lbl" style="color:#f59e0b;">ðŸ›¡ Extreme Point</span>
            <span class="badge" style="background:rgba(245,158,11,0.2); color:#f59e0b; border-color:#f59e0b;">WHIPSAW FILTER</span>
          </div>
          <input class="finput" id="f_ep" type="text"
            placeholder="HIGH of crossover candle (BUY) / LOW (SELL)"
            inputmode="decimal" autocomplete="off"
            style="border-color:#f59e0b; color:#fef3c7;">
          <div style="font-size:10px; color:#92400e; font-weight:700; margin-top:4px; padding:0 2px; font-family:'JetBrains Mono',monospace; background:rgba(245,158,11,0.1); border-radius:4px; padding:4px 8px;">
            Enter manually â€” candle High/Low where +DI/-DI last crossed
          </div>
        </div>

      </div><!-- /form-scroll -->

      <div class="form-footer">
        <button class="btn btn-orange" onclick="copyAll()">ðŸ“‹ COPY</button>
        <button class="btn btn-ghost btn-sm" onclick="clearForm()">CLEAR</button>
      </div>
      <div id="sendBar" style="display:none; padding:10px 12px; background:var(--card); border-top:1px solid var(--border);">
        <button class="btn btn-green" style="width:100%; font-size:15px; padding:15px;" onclick="sendToCalculator()">
          ðŸš€ SEND TO CALCULATOR
        </button>
      </div>
    </div>
  </div>

  <!-- CALCULATOR PANEL -->
  <div class="panel" id="calcPanel" style="overflow-y:auto; background:#f1f5f9;">

    <!-- TradeEye banner â€” shown when data arrives from scanner -->
    <div id="calcBanner" style="display:none; margin:14px 14px 0; background:linear-gradient(135deg,#0f172a,#1e293b); border-radius:16px; padding:14px 16px; border:1.5px solid #3b82f6;">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">ðŸ“¡</span>
          <div>
            <div style="font-size:11px; font-weight:800; color:#60a5fa; letter-spacing:1px; font-family:'Rajdhani',sans-serif;">FROM TRADEEYE SCANNER</div>
            <div id="bannerTxt" style="font-size:13px; font-weight:900; color:#f8fafc; font-family:'Rajdhani',sans-serif;">Data pre-filled âœ“</div>
          </div>
        </div>
        <button onclick="document.getElementById('calcBanner').style.display='none'"
          style="background:transparent; border:none; color:#64748b; font-size:18px; cursor:pointer; padding:4px 8px;">âœ•</button>
      </div>
      <div style="margin-top:6px; font-size:11px; font-weight:600; color:#94a3b8; font-family:'JetBrains Mono',monospace;">Select BUY or SELL, set lot size + balance â†’ calculate</div>
    </div>

    <div style="max-width:480px; margin:0 auto; padding:14px;">

      <!-- TRADE SETUP CARD -->
      <div class="calc-card">
        <div class="calc-sec">Trade Setup</div>

        <!-- Timeframe pills -->
        <div style="margin-bottom:16px;">
          <label class="calc-lbl">Timeframe</label>
          <div id="tfPills" style="display:flex; flex-wrap:wrap; gap:7px; margin-bottom:10px;"></div>
          <div id="tfContext" style="padding:10px 14px; background:#f0f9ff; border:1.5px solid #bae6fd; border-radius:10px; display:flex; gap:10px; align-items:flex-start;">
            <div id="tfBadge" style="background:#2563eb; color:#fff; font-size:12px; font-weight:900; padding:4px 10px; border-radius:8px; flex-shrink:0; margin-top:1px; font-family:'Rajdhani',sans-serif;">5M</div>
            <div>
              <div id="tfLabel" style="font-size:12px; font-weight:800; color:#0369a1; margin-bottom:2px; font-family:'Rajdhani',sans-serif;">5 Minute Chart</div>
              <div id="tfCtx" style="font-size:11px; font-weight:600; color:#0c4a6e; font-family:'JetBrains Mono',monospace;">Scalp â€” SL 5-15 pips typical.</div>
            </div>
          </div>
        </div>

        <!-- Pair -->
        <div style="margin-bottom:12px;">
          <label class="calc-lbl">Instrument / Pair</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="c_pair" class="calc-inp" style="flex:1;" onchange="calcPairChanged()"></select>
            <input id="c_pair_custom" class="calc-inp" type="text" placeholder="e.g. BEATUSDT"
              style="flex:1; display:none; text-transform:uppercase;"
              oninput="this.value=this.value.toUpperCase(); calcUpdate()"
              autocomplete="off" autocorrect="off" spellcheck="false">
          </div>
          <!-- Toggle custom -->
          <div style="margin-top:6px;">
            <button id="customToggleBtn" onclick="toggleCustomPair()"
              style="background:none; border:1px solid var(--border); border-radius:8px; padding:5px 12px;
                     font-size:11px; font-weight:700; color:var(--muted); cursor:pointer;
                     font-family:'JetBrains Mono',monospace; letter-spacing:1px;">
              + USE CUSTOM INSTRUMENT
            </button>
          </div>
          <div id="pairNote" style="display:none; padding:10px 14px; border-radius:10px; margin-top:8px;">
            <div id="pairNoteText" style="font-size:12px; font-weight:700; line-height:1.5;"></div>
          </div>
        </div>

        <!-- Custom instrument config â€” shown when unknown pair is used -->
        <div id="customCfgPanel" style="display:none; background:#1e293b; border-radius:14px; padding:14px; margin-bottom:12px; border:1.5px solid #3b82f6;">
          <div style="font-size:11px; font-weight:800; color:#60a5fa; letter-spacing:2px; margin-bottom:12px; font-family:'Rajdhani',sans-serif;">
            âš™ CUSTOM INSTRUMENT SETTINGS
          </div>
          <div style="font-size:11px; font-weight:600; color:#94a3b8; margin-bottom:12px; font-family:'JetBrains Mono',monospace; line-height:1.6;">
            Set these 3 values for correct pip & P&L calculation on any instrument.
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div>
              <label class="calc-lbl" style="color:#94a3b8;">Pip Mult</label>
              <input id="c_custom_pm" class="calc-inp" type="number" step="any" value="10000"
                placeholder="10000" inputmode="decimal" oninput="calcUpdate()"
                style="background:#0f172a; border-color:#334155; color:#f8fafc;">
            </div>
            <div>
              <label class="calc-lbl" style="color:#94a3b8;">Pip Val $</label>
              <input id="c_custom_pv" class="calc-inp" type="number" step="any" value="0.10"
                placeholder="0.10" inputmode="decimal" oninput="calcUpdate()"
                style="background:#0f172a; border-color:#334155; color:#f8fafc;">
            </div>
            <div>
              <label class="calc-lbl" style="color:#94a3b8;">Decimals</label>
              <input id="c_custom_dec" class="calc-inp" type="number" step="1" value="5"
                placeholder="5" inputmode="numeric" oninput="calcUpdate()"
                style="background:#0f172a; border-color:#334155; color:#f8fafc;">
            </div>
          </div>
          <!-- Quick presets -->
          <div style="font-size:10px; font-weight:800; color:#64748b; letter-spacing:1px; margin-bottom:6px; font-family:'Rajdhani',sans-serif;">QUICK PRESETS:</div>
          <div style="display:flex; flex-wrap:wrap; gap:6px;">
            <button onclick="applyPreset(10000,0.10,5)" class="preset-btn">Forex Major</button>
            <button onclick="applyPreset(100,0.07,3)"   class="preset-btn">JPY Pair</button>
            <button onclick="applyPreset(10,0.10,2)"    class="preset-btn">Gold/Oil</button>
            <button onclick="applyPreset(1,0.10,2)"     class="preset-btn">Bitcoin</button>
            <button onclick="applyPreset(1000,0.10,4)"  class="preset-btn">Crypto (small)</button>
            <button onclick="applyPreset(1,0.10,1)"     class="preset-btn">Index</button>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label class="calc-lbl">Direction</label>
            <select id="c_dir" class="calc-inp" style="color:#6b7280;" onchange="calcUpdate()">
              <option value="">Select</option>
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </div>
          <div>
            <label class="calc-lbl">Entry Price</label>
            <input id="c_entry" class="calc-inp" type="number" step="any" placeholder="0.00" inputmode="decimal" oninput="calcUpdate()">
          </div>
          <div>
            <label class="calc-lbl">Balance ($)</label>
            <input id="c_balance" class="calc-inp" type="number" step="any" placeholder="1000" value="1000" inputmode="decimal" oninput="calcUpdate()">
          </div>
          <div>
            <label class="calc-lbl">Lot Size</label>
            <select id="c_lot" class="calc-inp" onchange="calcUpdate()">
              <option>0.001</option><option>0.01</option><option selected>0.02</option>
              <option>0.03</option><option>0.05</option><option>0.10</option>
              <option>0.20</option><option>0.50</option><option>1.00</option>
              <option>2.00</option><option>5.00</option>
            </select>
          </div>
          <div>
            <label class="calc-lbl">Leverage</label>
            <select id="c_lev" class="calc-inp" onchange="calcUpdate()">
              <option>10</option><option>20</option><option>30</option><option>50</option>
              <option>100</option><option selected>200</option><option>400</option>
              <option>500</option><option>1000</option>
            </select>
          </div>
        </div>
      </div>

      <!-- INDICATORS CARD -->
      <div class="calc-card">
        <div id="calcIndSec" class="calc-sec">Wilder Indicators â€” 5M Chart</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div><label class="calc-lbl">ATR</label>
            <input id="c_atr" class="calc-inp" type="number" step="any" placeholder="0.00041" inputmode="decimal" oninput="calcUpdate()"></div>
          <div><label class="calc-lbl">Parabolic SAR</label>
            <input id="c_sar" class="calc-inp" type="number" step="any" placeholder="0.71189" inputmode="decimal" oninput="calcUpdate()"></div>
          <div><label class="calc-lbl">ADX</label>
            <input id="c_adx" class="calc-inp" type="number" step="any" placeholder="22.56" inputmode="decimal" oninput="calcUpdate()"></div>
          <div><label class="calc-lbl">+DI</label>
            <input id="c_pdi" class="calc-inp" type="number" step="any" placeholder="32.26" inputmode="decimal" oninput="calcUpdate()"></div>
          <div><label class="calc-lbl">-DI</label>
            <input id="c_ndi" class="calc-inp" type="number" step="any" placeholder="14.03" inputmode="decimal" oninput="calcUpdate()"></div>
          <div><label class="calc-lbl">RSI</label>
            <input id="c_rsi" class="calc-inp" type="number" step="any" placeholder="73.43" inputmode="decimal" oninput="calcUpdate()"></div>
        </div>

        <!-- EXTREME POINT â€” Wilder's whipsaw filter -->
        <div style="margin-top:14px; padding:14px; background:#0f172a; border-radius:14px; border:2px solid #f59e0b;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <span style="font-size:16px;">ðŸ›¡</span>
            <div style="font-size:12px; font-weight:900; color:#f59e0b; letter-spacing:1.5px; font-family:'Rajdhani',sans-serif;">EXTREME POINT â€” WILDER'S WHIPSAW FILTER</div>
          </div>
          <div style="font-size:11px; font-weight:600; color:#94a3b8; font-family:'JetBrains Mono',monospace; line-height:1.7; margin-bottom:12px;">
            The candle where +DI/-DI crossed sets the Extreme Point.<br>
            BUY â†’ HIGH of that crossover candle.<br>
            SELL â†’ LOW of that crossover candle.<br>
            <span style="color:#f59e0b; font-weight:800;">Price MUST break this level before you enter. No break = NO TRADE.</span>
          </div>
          <div>
            <label class="calc-lbl" style="color:#f59e0b;">Extreme Point Price</label>
            <input id="c_ep" class="calc-inp" type="number" step="any"
              placeholder="Enter crossover candle High (BUY) or Low (SELL)"
              inputmode="decimal" oninput="calcUpdate()"
              style="background:#1e293b; border-color:#f59e0b; color:#fef3c7; font-weight:800;">
          </div>
          <div id="epStatus" style="display:none; margin-top:10px; padding:12px 14px; border-radius:10px; text-align:center;"></div>
        </div>
      </div>

      <!-- VALIDATION -->
      <div id="validCard" class="calc-card" style="display:none;">
        <div class="calc-sec" id="validSec">Wilder Rule Check</div>
        <div id="validChecks" style="display:flex; flex-direction:column; gap:8px;"></div>
        <div id="validResult" style="margin-top:12px; padding:14px 16px; border-radius:14px; text-align:center;"></div>
      </div>

      <!-- RESULTS -->
      <div id="tradeHeader" style="display:none; border-radius:18px; padding:18px 20px; text-align:center; margin-bottom:14px;">
        <div id="tradeHeaderSub" style="font-size:10px; font-weight:800; color:rgba(255,255,255,0.6); letter-spacing:3px; margin-bottom:4px; font-family:'Rajdhani',sans-serif;"></div>
        <div id="tradeHeaderMain" style="font-size:28px; font-weight:900; color:#fff; font-family:'Rajdhani',sans-serif;"></div>
        <div id="tradeHeaderEntry" style="font-size:13px; font-weight:700; color:rgba(255,255,255,0.8); margin-top:6px; font-family:'JetBrains Mono',monospace;"></div>
      </div>

      <div id="levelsCard" class="calc-card" style="display:none;">
        <div id="levelsSec" class="calc-sec">Trade Levels</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <div id="slBox" class="price-box" style="flex:1; border-color:#fca5a5; background:#fef2f2; color:#dc2626;"></div>
          <div id="tp1Box" class="price-box" style="flex:1; border-color:#86efac; background:#f0fdf4; color:#16a34a;"></div>
        </div>
        <div id="tp2Box" style="background:#eff6ff; border:1.5px solid #93c5fd; border-radius:14px; padding:14px 12px; text-align:center;"></div>
        <div id="levelsNotes"></div>
      </div>

      <div id="statsCard" class="calc-card" style="display:none;">
        <div class="calc-sec">Account Stats</div>
        <div id="statsGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;"></div>
        <div id="statsNotes"></div>
      </div>

      <!-- EMPTY STATE -->
      <div id="calcEmpty" class="calc-card" style="text-align:center; padding:40px 20px;">
        <div style="font-size:44px; margin-bottom:14px;">ðŸ§®</div>
        <div style="font-size:16px; font-weight:800; color:#374151; margin-bottom:8px; font-family:'Rajdhani',sans-serif;">Select timeframe, pair and fill in all values</div>
        <div style="font-size:13px; font-weight:500; color:#9ca3af; font-family:'JetBrains Mono',monospace;">SL, TP and full Wilder analysis will appear here</div>
      </div>

      <div style="text-align:center; font-size:11px; font-weight:600; color:#9ca3af; padding:16px 0 20px; font-family:'JetBrains Mono',monospace;">
        Based on Welles Wilder â€” New Concepts in Technical Trading Systems (1978)
      </div>
    </div>
  </div>

</div><!-- /app-body -->
<div class="toast" id="toast"></div>

<script>
  // â”€â”€ STATE â”€â”€
  let stream         = null;
  let camActive      = false;
  let uploadB64      = null;
  let uploadMimeType = 'image/jpeg';
  let isProcessing   = false;
  let autoMode       = false;
  let countdownTimer = null;
  let countdownSec   = 5;
  const COUNTDOWN_START = 5;
  const CIRCUMFERENCE  = 2 * Math.PI * 28; // r=28 â†’ ~175.9

  const FIELD_MAP = {
    pair:     'f_pair',
    timeframe:'f_tf',
    entry:    'f_entry',
    sar:      'f_sar',
    atr:      'f_atr',
    adx:      'f_adx',
    plus_di:  'f_pdi',
    minus_di: 'f_ndi',
    rsi:      'f_rsi',
    ep:       'f_ep'
  };

  const ALL_IDS = Object.values(FIELD_MAP);

  // â”€â”€ HELPERS â”€â”€
  function setStatus(txt, state = '') {
    document.getElementById('stext').textContent = txt;
    document.getElementById('sdot').className = 'sdot' + (state ? ' ' + state : '');
  }

  function toast(msg, dur = 2800) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), dur);
  }

  function showPanel(name) {
    const panels = { camera:'cameraPanel', upload:'uploadPanel', form:'formPanel', calc:'calcPanel' };
    const tabs   = { camera:'tabCam',      upload:'tabUp',       form:'tabForm',   calc:'tabCalc'  };
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(panels[name]).classList.add('active');
    document.getElementById(tabs[name]).classList.add('active');
  }

  // â”€â”€ CAMERA â”€â”€
  async function handleCamBtn() {
    camActive ? stopCam() : startCam();
  }

  async function startCam() {
    try {
      setStatus('REQUESTINGâ€¦', 'scan');
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width:       { ideal: 1920 },
          height:      { ideal: 1080 },
          aspectRatio: { ideal: 1.7778 }
        }
      });
      document.getElementById('video').srcObject = stream;
      document.getElementById('camIdle').style.display = 'none';
      document.getElementById('reticle').classList.add('on');
      camActive = true;
      const btn = document.getElementById('camMainBtn');
      btn.textContent = 'â¹ STOP CAMERA';
      btn.className = 'btn btn-ghost';
      document.getElementById('scanBtn').disabled = false;
      setStatus('LIVE', 'live');
    } catch(e) {
      setStatus('ERROR', 'err');
      toast('âš  Camera denied: ' + e.message);
    }
  }

  function stopCam() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    document.getElementById('video').srcObject = null;
    camActive = false;
    // Stop auto mode
    autoMode = false;
    stopCountdown();
    const autoBtn = document.getElementById('autoBtn');
    autoBtn.className = 'auto-btn off';
    autoBtn.textContent = 'âš¡ AUTO';
    document.getElementById('reticle').classList.remove('on');
    document.getElementById('camIdle').style.display = 'flex';
    const btn = document.getElementById('camMainBtn');
    btn.textContent = 'â–¶ START CAMERA';
    btn.className = 'btn btn-blue';
    document.getElementById('scanBtn').disabled = true;
    setStatus('STANDBY');
  }

  // â”€â”€ AUTO CAPTURE â”€â”€
  function toggleAuto() {
    if (!camActive) { toast('âš  Start camera first'); return; }
    autoMode = !autoMode;
    const btn = document.getElementById('autoBtn');
    if (autoMode) {
      btn.className = 'auto-btn on';
      btn.textContent = 'âš¡ AUTO ON';
      startCountdown();
    } else {
      btn.className = 'auto-btn off';
      btn.textContent = 'âš¡ AUTO';
      stopCountdown();
    }
  }

  function startCountdown() {
    stopCountdown();
    countdownSec = COUNTDOWN_START;
    document.getElementById('countdownWrap').classList.add('on');
    updateCountdownUI();
    countdownTimer = setInterval(() => {
      countdownSec--;
      updateCountdownUI();
      if (countdownSec <= 0) {
        stopCountdown();
        doScan().then(() => {
          // Restart countdown after scan completes if still in auto mode
          if (autoMode) {
            setTimeout(() => { if (autoMode) startCountdown(); }, 1500);
          }
        });
      }
    }, 1000);
  }

  function stopCountdown() {
    if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
    document.getElementById('countdownWrap').classList.remove('on');
  }

  function updateCountdownUI() {
    document.getElementById('countdownNum').textContent = countdownSec;
    const fill = document.getElementById('ringFill');
    const progress = (COUNTDOWN_START - countdownSec) / COUNTDOWN_START;
    fill.style.strokeDashoffset = CIRCUMFERENCE * (1 - progress);
    // Color shift: green â†’ yellow â†’ orange as countdown nears zero
    const hue = Math.round(120 * (countdownSec / COUNTDOWN_START));
    fill.style.stroke = `hsl(${hue}, 90%, 55%)`;
  }

  function clearCamPreview() {
    const pi = document.getElementById('previewImg');
    pi.style.display = 'none';
    pi.src = '';
    document.getElementById('video').style.display = 'block';
    document.getElementById('camClearBtn').style.display = 'none';
  }

  // Resets frozen preview, stops auto mode, clears stuck processing state
  function freshStart() {
    // Clear frozen frame
    const pi = document.getElementById('previewImg');
    pi.style.display = 'none';
    pi.src = '';
    document.getElementById('video').style.display = 'block';
    document.getElementById('camClearBtn').style.display = 'none';
    // Stop auto mode and countdown
    autoMode = false;
    stopCountdown();
    const autoBtn = document.getElementById('autoBtn');
    autoBtn.className = 'auto-btn off';
    autoBtn.textContent = 'âš¡ AUTO';
    // Reset processing state in case it got stuck
    isProcessing = false;
    document.getElementById('analyzing').classList.remove('on');
    document.getElementById('scanBtn').disabled = !camActive;
    // Reset status
    setStatus(camActive ? 'LIVE' : 'STANDBY', camActive ? 'live' : '');
    toast('â†º Reset â€” ready to scan');
  }

  // â”€â”€ UPLOAD â”€â”€
  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      // Extract real media type from data URL (image/png, image/jpeg etc)
      uploadB64      = dataUrl.split(',')[1];
      uploadMimeType = dataUrl.split(';')[0].split(':')[1] || 'image/jpeg';
      document.getElementById('uploadPreviewImg').src = dataUrl;
      document.getElementById('uploadPreviewWrap').style.display = 'block';
      document.getElementById('uploadArea').style.display = 'none';
      document.getElementById('uploadScanBtn').disabled = false;
      document.getElementById('uploadClearBtn').style.display = 'flex';
      setStatus('LOADED', 'live');
      toast('âœ“ Chart loaded â€” tap âš¡ SCAN');
    };
    reader.readAsDataURL(file);
  }

  function clearUpload() {
    uploadB64 = null;
    uploadMimeType = 'image/jpeg';
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadPreviewWrap').style.display = 'none';
    document.getElementById('uploadArea').style.display = 'flex';
    document.getElementById('uploadScanBtn').disabled = true;
    document.getElementById('uploadClearBtn').style.display = 'none';
    setStatus('STANDBY');
  }

  const ua = document.getElementById('uploadArea');
  ua.addEventListener('dragover', e => { e.preventDefault(); ua.classList.add('dragover'); });
  ua.addEventListener('dragleave', () => ua.classList.remove('dragover'));
  ua.addEventListener('drop', e => {
    e.preventDefault();
    ua.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file?.type.startsWith('image/')) {
      const dt = new DataTransfer();
      dt.items.add(file);
      document.getElementById('fileInput').files = dt.files;
      handleFile({ target: { files: [file] } });
    }
  });

  // â”€â”€ SCAN â”€â”€
  async function doScan() {
    if (isProcessing) return;

    let b64 = uploadB64;

    // Grab camera frame if no upload
    if (!b64 && camActive) {
      const video  = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      b64 = canvas.toDataURL('image/jpeg', 0.92).split(',')[1];
      // Show frozen preview
      const pi = document.getElementById('previewImg');
      pi.src = 'data:image/jpeg;base64,' + b64;
      pi.style.display = 'block';
      document.getElementById('video').style.display = 'none';
      document.getElementById('camClearBtn').style.display = 'flex';
    }

    if (!b64) { toast('âš  No image to scan'); return; }

    isProcessing = true;
    setStatus('ANALYZINGâ€¦', 'scan');
    document.getElementById('analyzing').classList.add('on');
    document.getElementById('scanBtn').disabled = true;
    document.getElementById('uploadScanBtn').disabled = true;

    try {
      const res = await fetch('https://tradeeye.vercel.app/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1024,
          system: `You are a precise trading chart data extractor for TradingView charts using Wilder indicators. Extract values and return ONLY a valid JSON object â€” no markdown, no explanation, no backticks.

Return exactly these keys (use null if a value cannot be found):
{"pair":"","timeframe":"","entry":"","sar":"","atr":"","adx":"","plus_di":"","minus_di":"","rsi":"","ep":""}

Follow these exact rules for each field:

IMPORTANT: This image may be a screenshot, a photo of a screen, or a compressed image. Even if quality is reduced, extract all values you can read. Use every available source in the chart â€” header text, indicator labels, right-side boxes, colored labels â€” to find each value. Do your best even on lower quality images.

PAIR: Top-left corner instrument symbol. Read it exactly as shown â€” it may include suffixes like ".P" for perpetual contracts e.g. "BEATUSDT.P" â†’ return "BEATUSDT", "BTCUSD" â†’ return "BTCUSD", "XAUUSD" â†’ return "XAUUSD". Strip any exchange suffix but keep the full trading pair name. Also check the chart title text in the second row which shows the full name e.g. "Gold Spot / U.S. Dollar" â†’ return "XAUUSD", "BEATUSDT Perpetual Contract" â†’ return "BEATUSDT".

TIMEFRAME: In the top toolbar, find the currently SELECTED/HIGHLIGHTED timeframe button. It appears bolder, brighter or highlighted compared to others. Options: 1m 3m 5m 15m 30m 45m 1h 2h 4h D W M 3M 12M. Return exactly as shown e.g. "5m", "1h", "4h", "D". Do NOT guess â€” only return the visually active one.

ENTRY: Find the OHLC bar at the very top of the chart. It shows O H L C values. The ENTRY is the C (close) value â€” it appears after the letter "C" followed by a number e.g. "C5,238.070" â†’ return "5238.070", "C0.20610" â†’ return "0.20610". Do NOT use the price numbers on the right-side vertical price scale. Do NOT use the buy/sell box prices on the left. Use ONLY the C: close price from the top OHLC line.
CRITICAL FOR ALL NUMERIC VALUES: Return numbers WITHOUT commas. "4,065.80" â†’ "4065.80", "66,927.9" â†’ "66927.9", "1,336.4" â†’ "1336.4". Never include commas in any returned number.
EP: The Extreme Point is the HIGH price of the most recent candle where +DI crossed above -DI (for a bullish setup), or the LOW price of the most recent candle where -DI crossed above +DI (for a bearish setup). Look at where the ADX Wilder Dashboard DI lines cross on the chart â€” find that crossover candle and return its high (bullish) or low (bearish). Return null if you cannot determine this with confidence.

SAR: Find the label "Wilder Structure (Clean Simple)" in the top-left indicator area. The SAR value is the LAST number shown on that line e.g. "Wilder Structure (Clean Simple) 14 20 0.02 0.2  62839.2" â†’ return "62839.2". Also check the right side for a pink/red box labeled "Wilder Structure (Clean Simple):SAR".

ATR: Find the label "ATR-Current" in the indicator panel. Look for the ATR(14) value shown. On the right side there may be a box â€” use the "ATR (14)" row value.

ADX: Find "ADX Wilder Dashboard" indicator panel. The header line shows 3 numbers in this exact order: ADX value FIRST, then +DI value SECOND, then -DI value THIRD e.g. "ADX Wilder Dashboard (Pure v6) 14 14 20  10.54757  17.79356  21.93271" means ADX=10.54757, +DI=17.79356, -DI=21.93271. Also check the right side of the chart for colored label boxes:
- GREEN box labeled "+DI" = plus_di value
- RED box labeled "-DI" = minus_di value  
- GREEN/TEAL box labeled "ADX" = adx value
IMPORTANT: The header order is always ADX, +DI, -DI. Use this order if the right-side boxes are unclear. Never swap +DI and -DI.

RSI: Find "RSI-Wilder" indicator panel. On the right side look for the "RSI" labeled box or "WILDER RSI" value. Return the RSI number, NOT the 50.0 midline value.

Return ONLY the JSON object with no other text.`,
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: uploadB64 === b64 ? uploadMimeType : 'image/jpeg', data: b64 } },
              { type: 'text',  text: 'Extract all trading data from this chart.' }
            ]
          }]
        })
      });

      // Handle non-OK responses before parsing JSON
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Server ${res.status}: ${errText.slice(0, 150)}`);
      }

      const json = await res.json();
      if (json.error) throw new Error(json.error.message || json.error);

      const raw  = json.content.map(b => b.text || '').join('').replace(/```json|```/g, '').trim();
      const data = JSON.parse(raw);

      let filled = 0;
      Object.entries(FIELD_MAP).forEach(([key, id]) => {
        let val = data[key];
        if (val && val !== 'null' && val !== null) {
          // Strip commas from numeric values â€” AI often returns "4,065.80" instead of "4065.80"
          // Keep original for pair and timeframe (non-numeric fields)
          if (!['pair','timeframe','ep'].includes(key)) {
            val = String(val).replace(/,/g, '');
          }
          const el = document.getElementById(id);
          el.value = val;
          el.classList.add('has-value', 'popped');
          setTimeout(() => el.classList.remove('popped'), 600);
          filled++;
        }
      });

      setStatus(`${filled}/9 FIELDS`, 'live');
      toast(`âœ“ Extracted ${filled} values from chart`);
      // Show Send to Calculator button
      document.getElementById('sendBar').style.display = 'block';
      if (window.innerWidth < 768) showPanel('form');

    } catch(e) {
      setStatus('FAILED', 'err');
      toast('âš  ' + e.message);
      console.error(e);
    }

    isProcessing = false;
    document.getElementById('analyzing').classList.remove('on');
    document.getElementById('scanBtn').disabled = !camActive;
    document.getElementById('uploadScanBtn').disabled = !uploadB64;
  }

  // â”€â”€ FORM ACTIONS â”€â”€
  function clearForm() {
    ALL_IDS.forEach(id => {
      const el = document.getElementById(id);
      el.value = '';
      el.classList.remove('has-value', 'popped');
    });
    document.getElementById('sendBar').style.display = 'none';
    toast('Fields cleared');
  }

  function copyAll() {
    const labels = {
      f_pair:'Pair', f_tf:'Timeframe', f_entry:'Entry',
      f_sar:'SAR',   f_atr:'ATR',      f_adx:'ADX',
      f_pdi:'+DI',   f_ndi:'-DI',      f_rsi:'RSI',
      f_ep:'Extreme Point'
    };
    const lines = ALL_IDS
      .filter(id => document.getElementById(id).value)
      .map(id => `${labels[id]}: ${document.getElementById(id).value}`);
    if (!lines.length) { toast('âš  No data to copy'); return; }
    navigator.clipboard.writeText(lines.join('\n')).then(() => toast('âœ“ Copied to clipboard'));
  }

  // â”€â”€ PWA SERVICE WORKER â€” only on real deployed domain â”€â”€
  if ('serviceWorker' in navigator && location.hostname !== 'localhost' && !location.hostname.includes('claudeusercontent')) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('[TradeEye] SW registered'))
        .catch(e => console.log('[TradeEye] SW error', e));
    });
  }

  // â”€â”€ TIMEFRAME CONVERTER â”€â”€
  // TradeEye format â†’ Calculator format
  function convertTF(tf) {
    if (!tf) return '5M';
    const map = {
      '1m':'1M',  '1M':'1M',
      '3m':'5M',  '3M':'5M',
      '5m':'5M',  '5M':'5M',
      '15m':'15M','15M':'15M',
      '30m':'30M','30M':'30M',
      '45m':'30M','45M':'30M',
      '1h':'1H',  '1H':'1H',
      '2h':'2H',  '2H':'2H',
      '4h':'4H',  '4H':'4H',
      'd':'D1',   'D':'D1',   '1D':'D1', 'D1':'D1', 'Daily':'D1',
      'w':'W1',   'W':'W1',   '1W':'W1', 'W1':'W1', 'Weekly':'W1',
      'm':'MN',   'M':'MN',   '1M':'MN', 'MN':'MN', 'Monthly':'MN',
    };
    return map[tf] || map[tf.toUpperCase()] || '5M';
  }

  // â”€â”€ SEND TO CALCULATOR â”€â”€
  function sendToCalculator() {
    const pair    = document.getElementById('f_pair').value.trim().toUpperCase();
    const tf      = document.getElementById('f_tf').value.trim();
    const entry   = document.getElementById('f_entry').value.trim();
    const sar     = document.getElementById('f_sar').value.trim();
    const atr     = document.getElementById('f_atr').value.trim();
    const adx     = document.getElementById('f_adx').value.trim();
    const plusDI  = document.getElementById('f_pdi').value.trim();
    const minusDI = document.getElementById('f_ndi').value.trim();
    const rsi     = document.getElementById('f_rsi').value.trim();

    // Need at least pair + entry + the indicators to be useful
    if (!pair || !entry) {
      toast('âš  Scan a chart first'); return;
    }

    const calcTF = convertTF(tf);

    const params = new URLSearchParams({
      pair, tf: calcTF, entry, sar, atr,
      adx, plusDI, minusDI, rsi
    });

    // Remove empty params
    for (const [k, v] of [...params.entries()]) {
      if (!v) params.delete(k);
    }

    const url = `https://wilderscalculator.netlify.app/?${params.toString()}`;
    window.open(url, '_blank');
    toast('ðŸš€ Opening calculatorâ€¦');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ WILDER CALCULATOR ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const C_INSTRUMENTS = {
    'EURUSD':{cat:'Majors',pm:10000,pv:0.10,dec:5},'GBPUSD':{cat:'Majors',pm:10000,pv:0.10,dec:5},
    'AUDUSD':{cat:'Majors',pm:10000,pv:0.10,dec:5},'NZDUSD':{cat:'Majors',pm:10000,pv:0.10,dec:5},
    'USDCAD':{cat:'Majors',pm:10000,pv:0.10,dec:5},'USDCHF':{cat:'Majors',pm:10000,pv:0.10,dec:5},
    'USDJPY':{cat:'Majors',pm:100,pv:0.07,dec:3,jpy:true},
    'EURGBP':{cat:'Minors',pm:10000,pv:0.10,dec:5},'EURJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},
    'EURCAD':{cat:'Minors',pm:10000,pv:0.10,dec:5},'EURAUD':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'EURNZD':{cat:'Minors',pm:10000,pv:0.10,dec:5},'EURCHF':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'GBPJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},'GBPCAD':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'GBPAUD':{cat:'Minors',pm:10000,pv:0.10,dec:5},'GBPNZD':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'GBPCHF':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'AUDJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},'AUDCAD':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'AUDNZD':{cat:'Minors',pm:10000,pv:0.10,dec:5},'AUDCHF':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'NZDJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},'NZDCAD':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'CADJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},'CADCHF':{cat:'Minors',pm:10000,pv:0.10,dec:5},
    'CHFJPY':{cat:'Minors',pm:100,pv:0.07,dec:3,jpy:true},
    'USDZAR':{cat:'Exotics',pm:10000,pv:0.10,dec:5},'USDMXN':{cat:'Exotics',pm:10000,pv:0.10,dec:5},
    'USDTRY':{cat:'Exotics',pm:10000,pv:0.10,dec:5},'USDSGD':{cat:'Exotics',pm:10000,pv:0.10,dec:5},
    'XAUUSD':{cat:'Metals',pm:10,pv:0.10,dec:2,note:'Gold â€” pip value approx at 0.01 lot'},
    'XAGUSD':{cat:'Metals',pm:100,pv:0.05,dec:3,note:'Silver â€” approx'},
    'BTCUSD':{cat:'Crypto',pm:1,pv:0.10,dec:2,note:'Bitcoin â€” values approx'},
    'ETHUSD':{cat:'Crypto',pm:10,pv:0.10,dec:2,note:'Ethereum â€” approx'},
    'XRPUSD':{cat:'Crypto',pm:1000,pv:0.10,dec:4,note:'Ripple â€” approx'},
    'SOLUSD':{cat:'Crypto',pm:10,pv:0.10,dec:2,note:'Solana â€” approx'},
    'BNBUSD':{cat:'Crypto',pm:10,pv:0.10,dec:2,note:'BNB â€” approx'},
    'ADAUSD':{cat:'Crypto',pm:1000,pv:0.10,dec:4,note:'Cardano â€” approx'},
    'USOIL':{cat:'Commodities',pm:100,pv:0.10,dec:2,note:'WTI Crude Oil'},
    'UKOIL':{cat:'Commodities',pm:100,pv:0.10,dec:2,note:'Brent Crude'},
    'US30':{cat:'Indices',pm:1,pv:0.10,dec:1,note:'Dow Jones'},'SPX500':{cat:'Indices',pm:10,pv:0.10,dec:1,note:'S&P 500'},
    'NAS100':{cat:'Indices',pm:1,pv:0.10,dec:1,note:'Nasdaq 100'},'GER40':{cat:'Indices',pm:1,pv:0.10,dec:1,note:'DAX 40'},
  };

  const C_TIMEFRAMES = {
    '1M':{label:'1 Minute', ctx:'Scalp. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Quick exits.'},
    '5M':{label:'5 Minute', ctx:'Scalp. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Quick exits.'},
    '15M':{label:'15 Minute',ctx:'Intraday. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Monitor closely.'},
    '30M':{label:'30 Minute',ctx:'Intraday. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Trail SAR on trend.'},
    '1H':{label:'1 Hour',   ctx:'Intraday. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Trail SAR on trend.'},
    '2H':{label:'2 Hour',   ctx:'Swing. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Trail SAR on trend.'},
    '4H':{label:'4 Hour',   ctx:'Swing. SL = SAR. TP1 = 2xATR. TP2 = 3xATR. Trail SAR on trend.'},
    'D1':{label:'Daily',    ctx:'Position. Wilder primary timeframe. SL = SAR. Trail SAR â€” days/weeks possible.'},
    'W1':{label:'Weekly',   ctx:'Position. SL = SAR. Trail SAR â€” weeks/months possible.'},
    'MN':{label:'Monthly',  ctx:'Long-term position. SL = SAR. Trail SAR â€” months possible.'},
  };
  const TF_KEYS = ['1M','5M','15M','30M','1H','2H','4H','D1','W1','MN'];

  let calcTF = '5M';

  // â”€â”€ INIT CALCULATOR â”€â”€
  function initCalc() {
    // Build pair dropdown
    const sel = document.getElementById('c_pair');
    const cats = ['Majors','Minors','Exotics','Metals','Crypto','Commodities','Indices'];
    cats.forEach(cat => {
      const pairs = Object.keys(C_INSTRUMENTS).filter(p => C_INSTRUMENTS[p].cat === cat);
      if (!pairs.length) return;
      const grp = document.createElement('optgroup');
      grp.label = 'â”€â”€ ' + cat + ' â”€â”€';
      pairs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p + (C_INSTRUMENTS[p].jpy ? ' â˜…JPY' : '');
        grp.appendChild(opt);
      });
      sel.appendChild(grp);
    });
    sel.value = 'AUDUSD';

    // Build TF pills
    const container = document.getElementById('tfPills');
    TF_KEYS.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'tf-pill' + (t === calcTF ? ' active' : '');
      btn.textContent = t;
      btn.onclick = () => setCalcTF(t);
      container.appendChild(btn);
    });
    updateTFContext();
  }

  function setCalcTF(tf) {
    calcTF = tf;
    document.querySelectorAll('.tf-pill').forEach(b => {
      b.className = 'tf-pill' + (b.textContent === tf ? ' active' : '');
    });
    updateTFContext();
    calcUpdate();
  }

  function updateTFContext() {
    const tf = C_TIMEFRAMES[calcTF];
    document.getElementById('tfBadge').textContent = calcTF;
    document.getElementById('tfLabel').textContent = tf.label + ' Chart';
    document.getElementById('tfCtx').textContent = tf.ctx;
    document.getElementById('calcIndSec').textContent = 'Wilder Indicators â€” ' + calcTF + ' Chart';
  }

  // â”€â”€ CUSTOM PAIR TOGGLE â”€â”€
  let useCustomPair = false;

  function toggleCustomPair() {
    useCustomPair = !useCustomPair;
    const sel    = document.getElementById('c_pair');
    const custom = document.getElementById('c_pair_custom');
    const panel  = document.getElementById('customCfgPanel');
    const btn    = document.getElementById('customToggleBtn');
    if (useCustomPair) {
      sel.style.display    = 'none';
      custom.style.display = 'block';
      panel.style.display  = 'block';
      btn.textContent      = 'â† USE STANDARD PAIR';
      btn.style.color      = '#60a5fa';
      btn.style.borderColor= '#3b82f6';
      document.getElementById('pairNote').style.display = 'none';
    } else {
      sel.style.display    = 'block';
      custom.style.display = 'none';
      panel.style.display  = 'none';
      btn.textContent      = '+ USE CUSTOM INSTRUMENT';
      btn.style.color      = '';
      btn.style.borderColor= '';
      calcPairChanged();
    }
    calcUpdate();
  }

  function applyPreset(pm, pv, dec) {
    document.getElementById('c_custom_pm').value  = pm;
    document.getElementById('c_custom_pv').value  = pv;
    document.getElementById('c_custom_dec').value = dec;
    calcUpdate();
  }

  // Auto-suggest best preset based on pair name patterns
  function autoSuggestPreset(pair) {
    const p = pair.toUpperCase();
    if (p.includes('JPY'))                          applyPreset(100,  0.07, 3); // JPY pairs
    else if (p.includes('XAU') || p.includes('GOLD')) applyPreset(10, 0.10, 2); // Gold
    else if (p.includes('XAG') || p.includes('OIL'))  applyPreset(100,0.10, 2); // Silver/Oil
    else if (p.includes('BTC') || p.includes('ETH'))  applyPreset(1,  0.10, 2); // Large crypto
    else if (p.includes('USD') && p.length <= 8)   applyPreset(10000,0.10, 5); // Normal forex
    else if (p.includes('USDT') || p.includes('PERP')) applyPreset(1, 0.10, 5); // Crypto perp
    else                                            applyPreset(10000,0.10, 5); // Default forex
  }

  // â”€â”€ GET ACTIVE CFG â€” works for both standard and custom pairs â”€â”€
  function getActiveCfg() {
    if (useCustomPair) {
      const pm  = +document.getElementById('c_custom_pm').value  || 10000;
      const pv  = +document.getElementById('c_custom_pv').value  || 0.10;
      const dec = +document.getElementById('c_custom_dec').value || 5;
      return { pm, pv, dec, custom: true };
    }
    const pair = document.getElementById('c_pair').value;
    return C_INSTRUMENTS[pair] || { pm:10000, pv:0.10, dec:5 };
  }

  function getActivePairName() {
    if (useCustomPair) {
      return document.getElementById('c_pair_custom').value.trim().toUpperCase() || 'CUSTOM';
    }
    return document.getElementById('c_pair').value;
  }

  function calcPairChanged() {
    const pair = document.getElementById('c_pair').value;
    const cfg = C_INSTRUMENTS[pair] || {};
    const noteEl = document.getElementById('pairNote');
    const noteTxt = document.getElementById('pairNoteText');
    if (cfg.jpy) {
      noteEl.style.display = 'block';
      noteEl.style.background = '#eff6ff'; noteEl.style.border = '1.5px solid #93c5fd';
      noteTxt.style.color = '#1d4ed8';
      noteTxt.textContent = 'âš¡ JPY Pair â€” Pip = 0.01 (2nd decimal). Pip value ~$0.07 at 0.01 lot.';
    } else if (cfg.note) {
      noteEl.style.display = 'block';
      noteEl.style.background = '#fffbeb'; noteEl.style.border = '1.5px solid #fde047';
      noteTxt.style.color = '#854d0e';
      noteTxt.textContent = 'ðŸ“Œ ' + cfg.note;
    } else {
      noteEl.style.display = 'none';
    }
    calcUpdate();
  }

  // â”€â”€ FILL CALC FROM SCANNER â”€â”€
  // Strip commas from any number string â€” type="number" inputs reject "1,921.17"
  function stripCommas(v) { return v.replace(/,/g, ''); }

  function fillCalcFromScan() {
    const pair    = document.getElementById('f_pair').value.trim().toUpperCase();
    const tf      = document.getElementById('f_tf').value.trim();
    const entry   = stripCommas(document.getElementById('f_entry').value.trim());
    const sar     = stripCommas(document.getElementById('f_sar').value.trim());
    const atr     = stripCommas(document.getElementById('f_atr').value.trim());
    const adx     = stripCommas(document.getElementById('f_adx').value.trim());
    const plusDI  = stripCommas(document.getElementById('f_pdi').value.trim());
    const minusDI = stripCommas(document.getElementById('f_ndi').value.trim());
    const rsi     = stripCommas(document.getElementById('f_rsi').value.trim());

    // Set pair â€” use custom mode if not in database
    if (pair) {
      if (C_INSTRUMENTS[pair]) {
        // Known pair â€” use standard selector
        if (useCustomPair) toggleCustomPair(); // switch back to standard if needed
        document.getElementById('c_pair').value = pair;
        calcPairChanged();
      } else {
        // Unknown pair â€” auto switch to custom mode
        if (!useCustomPair) toggleCustomPair();
        document.getElementById('c_pair_custom').value = pair;
        // Auto-suggest preset based on pair name
        autoSuggestPreset(pair);
      }
    }
    // Convert and set timeframe
    const calcTFVal = convertTF(tf);
    setCalcTF(calcTFVal);

    // Fill indicator fields
    if (entry)   document.getElementById('c_entry').value = entry;
    if (sar)     document.getElementById('c_sar').value   = sar;
    if (atr)     document.getElementById('c_atr').value   = atr;
    if (adx)     document.getElementById('c_adx').value   = adx;
    if (plusDI)  document.getElementById('c_pdi').value   = plusDI;
    if (minusDI) document.getElementById('c_ndi').value   = minusDI;
    if (rsi)     document.getElementById('c_rsi').value   = rsi;
    // EP â€” clear it when new scan arrives so user must confirm it manually
    document.getElementById('c_ep').value = '';

    // Show banner
    const banner = document.getElementById('calcBanner');
    const bannerTxt = document.getElementById('bannerTxt');
    banner.style.display = 'block';
    bannerTxt.textContent = (getActivePairName() || pair || '?') + ' Â· ' + (calcTFVal || '?') + ' â€” Data pre-filled âœ“';

    calcUpdate();
    showPanel('calc');
    toast('ðŸš€ Sent to Calculator!');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ WILDER VALIDATION â€” STRICTLY AS WELLES WILDER WROTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //
  // ADX < 20   = RANGING MARKET  â€” RSI is primary tool (30/70)
  // ADX 20-25  = NO MAN'S LAND   â€” DO NOT TRADE. Period.
  // ADX > 25   = TRENDING MARKET â€” DI crossover + EP + SAR trail
  //
  // SL = SAR EXACTLY. Always. No other calculation.
  // DI lines are IRRELEVANT in ranging market.
  // RSI 30/70 is IRRELEVANT in trending market (used as direction only).
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function getMarketMode(adx) {
    if (adx < 20)  return 'RANGE';
    if (adx < 25)  return 'NOmans';
    return 'TREND';
  }

  function runCalcValidation(adx, pdi, mdi, rsi, entry, sar, dir, ep) {
    const checks = [];
    const mode   = getMarketMode(adx);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NO MAN'S LAND â€” HARD BLOCK
    // ADX 20-25: Market is transitioning. Neither system applies.
    // Wilder: wait for ADX to declare itself above 25 or fall below 20.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (mode === 'NOmans') {
      checks.push({ok:false, noMans:true, text:
        'ADX ' + adx.toFixed(1) + ' â€” No Mans Land (20-25). Market is transitioning. ' +
        'This timeframe has no valid setup. Close this chart. ' +
        'Wait for ADX to rise above 25 (trend) or fall below 20 (range).'
      });
      return { checks, valid:false, epBlocked:false, epMissing:true, mode, noMans:true };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RANGING MARKET â€” ADX < 20
    // RSI is the PRIMARY signal. DI lines are ignored completely.
    // Wilder: RSI above 70 = overbought = SELL. RSI below 30 = oversold = BUY.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (mode === 'RANGE') {
      checks.push({ok:true, text:'ADX ' + adx.toFixed(1) + ' â€” Ranging market confirmed. RSI is the primary tool on this timeframe.'});

      if (dir === 'SELL') {
        if (rsi >= 70) {
          checks.push({ok:true,  text:'RSI ' + rsi.toFixed(1) + ' â€” Overbought (70+). SELL signal confirmed by Wilder ranging rule.'});
        } else if (rsi >= 60) {
          checks.push({ok:null,  text:'RSI ' + rsi.toFixed(1) + ' â€” Approaching overbought. Wait for RSI to reach 70 before entering SELL.'});
        } else {
          checks.push({ok:false, text:'RSI ' + rsi.toFixed(1) + ' â€” Not overbought. RSI must reach 70+ for a SELL in ranging market. Do not enter.'});
        }
      } else if (dir === 'BUY') {
        if (rsi <= 30) {
          checks.push({ok:true,  text:'RSI ' + rsi.toFixed(1) + ' â€” Oversold (30 or below). BUY signal confirmed by Wilder ranging rule.'});
        } else if (rsi <= 40) {
          checks.push({ok:null,  text:'RSI ' + rsi.toFixed(1) + ' â€” Approaching oversold. Wait for RSI to reach 30 before entering BUY.'});
        } else {
          checks.push({ok:false, text:'RSI ' + rsi.toFixed(1) + ' â€” Not oversold. RSI must reach 30 or below for a BUY in ranging market. Do not enter.'});
        }
      }

      // SAR still acts as stop loss in range mode
      if (dir === 'BUY') {
        checks.push(sar < entry
          ? {ok:true,  text:'SAR ' + sar + ' below price â€” Stop loss position valid.'}
          : {ok:false, text:'SAR ' + sar + ' is above price â€” Wait for SAR to flip below before entering BUY.'});
      } else if (dir === 'SELL') {
        checks.push(sar > entry
          ? {ok:true,  text:'SAR ' + sar + ' above price â€” Stop loss position valid.'}
          : {ok:false, text:'SAR ' + sar + ' is below price â€” Wait for SAR to flip above before entering SELL.'});
      }

      // DI note â€” informational only, does not block
      checks.push({ok:null, text:'DI lines â€” Not used in ranging market. Wilder uses RSI 30/70 only when ADX is below 20.'});

      const anyFail = checks.some(c => c.ok === false);
      return { checks, valid:!anyFail, epBlocked:false, epMissing:false, mode };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRENDING MARKET â€” ADX > 25
    // Full Wilder trend rules apply in this exact order.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    checks.push({ok:true, text:'ADX ' + adx.toFixed(1) + ' â€” Trending market confirmed (25+). Full Wilder trend rules apply.'});

    // â”€â”€ STEP 1: EXTREME POINT â€” RUNS FIRST, BLOCKS EVERYTHING â”€â”€
    // The single most important rule. No EP break = no trade regardless of anything else.
    if (ep && ep > 0) {
      if (dir === 'BUY') {
        if (entry >= ep) {
          checks.push({ok:true, text:'ðŸ›¡ EXTREME POINT ' + ep + ' â€” Price has broken above EP. Whipsaw eliminated. Entry confirmed.', ep:true});
        } else {
          checks.push({ok:false, text:'ðŸ›¡ EXTREME POINT ' + ep + ' â€” Price at ' + entry + ' has NOT broken above ' + ep + ' yet. DO NOT ENTER. This is the whipsaw zone. Wait for price to break ' + ep + '.', ep:true, blocked:true});
        }
      } else if (dir === 'SELL') {
        if (entry <= ep) {
          checks.push({ok:true, text:'ðŸ›¡ EXTREME POINT ' + ep + ' â€” Price has broken below EP. Whipsaw eliminated. Entry confirmed.', ep:true});
        } else {
          checks.push({ok:false, text:'ðŸ›¡ EXTREME POINT ' + ep + ' â€” Price at ' + entry + ' has NOT broken below ' + ep + ' yet. DO NOT ENTER. This is the whipsaw zone. Wait for price to break ' + ep + '.', ep:true, blocked:true});
        }
      }
    } else {
      checks.push({ok:null, text:'ðŸ›¡ EXTREME POINT â€” Not entered. Find the candle where DI lines crossed. Enter its High (BUY) or Low (SELL) to confirm this is not a whipsaw.', ep:true});
    }

    // â”€â”€ STEP 2: DI DIRECTION â”€â”€
    if (dir === 'BUY') {
      checks.push(pdi > mdi
        ? {ok:true,  text:'+DI ' + pdi + ' > -DI ' + mdi + ' â€” Bullish direction confirmed.'}
        : {ok:false, text:'-DI ' + mdi + ' > +DI ' + pdi + ' â€” Bearish DI dominates. Conflicts with BUY on this timeframe. Do not enter. Close this chart.'});
    } else if (dir === 'SELL') {
      checks.push(mdi > pdi
        ? {ok:true,  text:'-DI ' + mdi + ' > +DI ' + pdi + ' â€” Bearish direction confirmed.'}
        : {ok:false, text:'+DI ' + pdi + ' > -DI ' + mdi + ' â€” Bullish DI dominates. Conflicts with SELL on this timeframe. Do not enter. Close this chart.'});
    }

    // â”€â”€ STEP 3: SAR POSITION â”€â”€
    if (dir === 'BUY') {
      checks.push(sar < entry
        ? {ok:true,  text:'SAR ' + sar + ' below price â€” Uptrend structure valid. SAR is your stop loss.'}
        : {ok:false, text:'SAR ' + sar + ' is above price. Conflicts with BUY. Do not enter. Close this chart.'});
    } else if (dir === 'SELL') {
      checks.push(sar > entry
        ? {ok:true,  text:'SAR ' + sar + ' above price â€” Downtrend structure valid. SAR is your stop loss.'}
        : {ok:false, text:'SAR ' + sar + ' is below price. Conflicts with SELL. Do not enter. Close this chart.'});
    }

    // â”€â”€ STEP 4: RSI â€” MOMENTUM DIRECTION ONLY in trending market â”€â”€
    // NOT overbought/oversold here. Just confirming trend direction.
    if (dir === 'BUY') {
      checks.push(rsi > 50
        ? {ok:true, text:'RSI ' + rsi.toFixed(1) + ' above 50 â€” Bullish momentum confirming the trend direction.'}
        : {ok:null, text:'RSI ' + rsi.toFixed(1) + ' below 50 â€” Trend momentum not yet fully confirming. Monitor closely.'});
    } else if (dir === 'SELL') {
      checks.push(rsi < 50
        ? {ok:true, text:'RSI ' + rsi.toFixed(1) + ' below 50 â€” Bearish momentum confirming the trend direction.'}
        : {ok:null, text:'RSI ' + rsi.toFixed(1) + ' above 50 â€” Trend momentum not yet fully confirming. Monitor closely.'});
    }

    const epBlocked = checks.some(c => c.blocked);
    const anyFail   = checks.some(c => c.ok === false);
    return {
      checks,
      valid:     !anyFail,
      epBlocked: epBlocked,
      epMissing: !(ep && ep > 0),
      mode,
    };
  }

  // â”€â”€ MAIN CALC UPDATE â”€â”€
  function calcUpdate() {
    const dir     = document.getElementById('c_dir').value;
    const entry   = +document.getElementById('c_entry').value;
    const atr     = +document.getElementById('c_atr').value;
    const sar     = +document.getElementById('c_sar').value;
    const adx     = +document.getElementById('c_adx').value;
    const pdi     = +document.getElementById('c_pdi').value;
    const ndi     = +document.getElementById('c_ndi').value;
    const rsi     = +document.getElementById('c_rsi').value;
    const ep      = +document.getElementById('c_ep').value || 0;
    const lot     = +document.getElementById('c_lot').value;
    const balance = +document.getElementById('c_balance').value;
    const lev     = +document.getElementById('c_lev').value;

    const ready = entry && atr && sar && adx && pdi && ndi && rsi && dir;

    document.getElementById('calcEmpty').style.display = ready ? 'none' : 'block';
    document.getElementById('validCard').style.display = ready ? 'block' : 'none';
    document.getElementById('tradeHeader').style.display = ready ? 'block' : 'none';
    document.getElementById('levelsCard').style.display = ready ? 'block' : 'none';
    document.getElementById('statsCard').style.display = ready ? 'block' : 'none';

    if (!ready) return;

    const cfg     = getActiveCfg();
    const pair    = getActivePairName();
    const tf      = C_TIMEFRAMES[calcTF] || C_TIMEFRAMES['5M'];
    const pm      = cfg.pm;
    const pv      = cfg.pv * (lot / 0.01);
    const fmt     = v => v.toFixed(cfg.dec);
    const dirMult = dir === 'BUY' ? 1 : -1;
    const dirColor = dir === 'BUY' ? '#16a34a' : '#dc2626';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SL = SAR EXACTLY â€” Wilder's Significant Point
    // No other calculation. SAR is the stop. Period.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const slPrice = sar;                                  // SAR IS the stop loss
    const slPips  = Math.abs(entry - sar) * pm;          // pips distance for display
    const slLoss  = slPips * pv;                         // dollar risk

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TP = ATR BASED â€” Wilder's target calculation
    // TP1 = 2Ã—ATR â€” partial exit, move SL to breakeven
    // TP2 = 3Ã—ATR â€” second partial exit
    // TRAIL = SAR follows price â€” hold until SAR flips
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const atrPips  = atr * pm;
    const tp1Pips  = atrPips * 2;
    const tp2Pips  = atrPips * 3;
    const tp1Price = fmt(entry + dirMult * (tp1Pips / pm));
    const tp2Price = fmt(entry + dirMult * (tp2Pips / pm));
    const tp1Prof  = tp1Pips * pv;
    const tp2Prof  = tp2Pips * pv;
    const rr1      = slPips > 0 ? (tp1Pips / slPips).toFixed(2) : 'â€”';
    const rr2      = slPips > 0 ? (tp2Pips / slPips).toFixed(2) : 'â€”';
    const riskPct  = (slLoss / balance * 100).toFixed(1);
    const margin   = (lot * 100000) / lev;
    const free     = balance - margin;
    const mode     = getMarketMode(adx);

    document.getElementById('c_dir').style.color = dirColor;

    // â”€â”€ VALIDATION â”€â”€
    const v = runCalcValidation(adx, pdi, ndi, rsi, entry, sar, dir, ep);

    // â”€â”€ RENDER CHECKS â”€â”€
    const checksHTML = v.checks.map(c => {
      // EP check gets special amber styling
      if (c.ep) {
        const bg     = c.ok===true ?'#fef3c7':c.ok===false?'#7c2d12':'#1c1917';
        const border = c.ok===true ?'#f59e0b':c.ok===false?'#f97316':'#78716c';
        const color  = c.ok===true ?'#92400e':c.ok===false?'#fed7aa':'#d6d3d1';
        const icon   = c.ok===true ?'ðŸ›¡':c.ok===false?'ðŸ›¡':'ðŸ›¡';
        return `<div style="display:flex;align-items:flex-start;gap:10px;padding:13px 14px;border-radius:12px;background:${bg};border:2px solid ${border};">
          <span style="font-size:17px;">${icon}</span>
          <span style="font-size:12px;font-weight:700;line-height:1.6;color:${color};font-family:'JetBrains Mono',monospace;">${c.text}</span>
        </div>`;
      }
      const bg     = c.ok===true?'#f0fdf4':c.ok===false?'#fef2f2':'#fffbeb';
      const border = c.ok===true?'#86efac':c.ok===false?'#fca5a5':'#fcd34d';
      const color  = c.ok===true?'#15803d':c.ok===false?'#b91c1c':'#92400e';
      const icon   = c.ok===true?'âœ…':c.ok===false?'âŒ':'âš ï¸';
      return `<div style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border-radius:12px;background:${bg};border:1.5px solid ${border};">
        <span style="font-size:17px;">${icon}</span>
        <span style="font-size:13px;font-weight:700;line-height:1.5;color:${color};font-family:'JetBrains Mono',monospace;">${c.text}</span>
      </div>`;
    }).join('');
    document.getElementById('validChecks').innerHTML = checksHTML;

    // Mode label in section header
    const modeLabel = mode==='RANGE' ? 'RANGING MARKET â€” RSI 30/70' : mode==='NOmans' ? 'NO MANS LAND â€” DO NOT TRADE' : 'TRENDING MARKET â€” DI + EP + SAR';
    document.getElementById('validSec').textContent = 'Wilder Rule Check â€” ' + C_TIMEFRAMES[calcTF].label + ' Â· ' + modeLabel;

    // â”€â”€ RESULT BANNER â”€â”€
    let resultBg, resultText;
    if (v.noMans) {
      resultBg   = '#374151';
      resultText = 'â¸  NO MANS LAND â€” ADX ' + adx.toFixed(1) + ' is between 20-25. This timeframe has no valid setup. Close this chart and wait.';
    } else if (v.epBlocked) {
      resultBg   = '#7c2d12';
      resultText = 'ðŸ›¡  EXTREME POINT NOT BROKEN â€” DO NOT ENTER. Price must break ' + ep + ' first. Wait or skip this trade entirely.';
    } else if (mode === 'TREND' && v.epMissing && v.valid) {
      resultBg   = '#1d4ed8';
      resultText = 'âš   TREND RULES PASS â€” Enter Extreme Point above to confirm no whipsaw before entering.';
    } else {
      resultBg   = v.valid ? '#16a34a' : '#dc2626';
      resultText = v.valid
        ? (mode==='RANGE' ? 'âœ“  RANGE TRADE CONFIRMED â€” RSI signal valid. Take profit quickly. Do not trail.' : 'âœ“  TREND TRADE CONFIRMED â€” All Wilder rules passed. Trail SAR until it flips.')
        : 'âœ—  NO SETUP ON THIS TIMEFRAME â€” Close this chart. Do not look for alternatives.';
    }
    document.getElementById('validResult').style.background = resultBg;
    document.getElementById('validResult').innerHTML = `<span style="font-size:13px;font-weight:900;color:#fff;font-family:'Rajdhani',sans-serif;line-height:1.5;">${resultText}</span>`;

    // â”€â”€ TRADE HEADER â”€â”€
    const th = document.getElementById('tradeHeader');
    if (v.noMans) {
      th.style.background = '#374151';
      document.getElementById('tradeHeaderSub').textContent = 'â¸ NO MANS LAND â€” ' + C_TIMEFRAMES[calcTF].label.toUpperCase();
    } else if (v.epBlocked) {
      th.style.background = '#7c2d12';
      document.getElementById('tradeHeaderSub').textContent = 'ðŸ›¡ WAIT FOR EP BREAK â€” ' + C_TIMEFRAMES[calcTF].label.toUpperCase();
    } else if (mode === 'RANGE') {
      th.style.background = '#854d0e';
      document.getElementById('tradeHeaderSub').textContent = 'ðŸ“Š RANGE MODE Â· RSI SIGNAL Â· ' + C_TIMEFRAMES[calcTF].label.toUpperCase();
    } else if (mode === 'TREND' && v.epMissing) {
      th.style.background = '#1e40af';
      document.getElementById('tradeHeaderSub').textContent = 'âš  SET EXTREME POINT â€” ' + C_TIMEFRAMES[calcTF].label.toUpperCase();
    } else {
      th.style.background = dirColor;
      document.getElementById('tradeHeaderSub').textContent = 'âœ“ EP CONFIRMED Â· TREND MODE Â· ' + C_TIMEFRAMES[calcTF].label.toUpperCase();
    }
    document.getElementById('tradeHeaderMain').textContent = dir + ' ' + pair;
    document.getElementById('tradeHeaderEntry').textContent = 'Entry @ ' + fmt(entry) + (ep ? '  |  EP: ' + ep : '');

    // â”€â”€ TRADE LEVELS â€” mode-aware display â”€â”€
    // HARD GUARD: If SAR is on the wrong side of entry, levels are meaningless.
    // BUY needs SAR below entry. SELL needs SAR above entry.
    const sarWrongSide = (dir === 'BUY' && sar >= entry) || (dir === 'SELL' && sar <= entry);
    if (sarWrongSide) {
      document.getElementById('levelsSec').textContent = 'Trade Levels â€” INVALID';
      document.getElementById('slBox').innerHTML = '';
      document.getElementById('tp1Box').innerHTML = '';
      document.getElementById('tp2Box').innerHTML = '';
      document.getElementById('levelsNotes').innerHTML = `
        <div style="padding:14px 16px;background:#7f1d1d;border:2px solid #ef4444;border-radius:12px;margin-top:4px;">
          <div style="font-size:13px;font-weight:900;color:#fecaca;font-family:'Rajdhani',sans-serif;margin-bottom:6px;">
            â›” SAR IS ON THE WRONG SIDE OF ENTRY
          </div>
          <div style="font-size:12px;font-weight:700;color:#fca5a5;font-family:'JetBrains Mono',monospace;line-height:1.7;">
            BUY trade requires SAR below entry price.<br>
            SELL trade requires SAR above entry price.<br>
            Check the SAR value you entered â€” it may be wrong.<br>
            Current entry: ${fmt(entry)} Â· SAR entered: ${fmt(sar)}
          </div>
        </div>`;
      // Skip all further level rendering
    } else {

    document.getElementById('levelsSec').textContent = mode === 'RANGE'
      ? 'Trade Levels â€” ' + calcTF + ' Â· RANGE (Quick Exit)'
      : 'Trade Levels â€” ' + calcTF + ' Â· TREND (Trail SAR)';

    // SL â€” always SAR exactly
    document.getElementById('slBox').innerHTML = `
      <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'Rajdhani',sans-serif;">Stop Loss = SAR</div>
      <div style="font-size:15px;font-weight:900;margin-bottom:4px;word-break:break-all;font-family:'JetBrains Mono',monospace;">${fmt(slPrice)}</div>
      <div style="font-size:11px;font-weight:700;opacity:0.8;font-family:'JetBrains Mono',monospace;">${slPips.toFixed(1)} units</div>
      <div style="font-size:13px;font-weight:800;margin-top:2px;font-family:'JetBrains Mono',monospace;">-$${slLoss.toFixed(2)}</div>`;

    // TP1 â€” always 2Ã—ATR
    document.getElementById('tp1Box').innerHTML = `
      <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'Rajdhani',sans-serif;">TP1 Â· 2Ã—ATR</div>
      <div style="font-size:15px;font-weight:900;margin-bottom:4px;word-break:break-all;font-family:'JetBrains Mono',monospace;">${tp1Price}</div>
      <div style="font-size:11px;font-weight:700;opacity:0.8;font-family:'JetBrains Mono',monospace;">${tp1Pips.toFixed(1)} units</div>
      <div style="font-size:13px;font-weight:800;margin-top:2px;font-family:'JetBrains Mono',monospace;">+$${tp1Prof.toFixed(2)}</div>`;

    // TP2 / Trail â€” different message per mode
    if (mode === 'RANGE') {
      // Range: quick exit at 3Ã—ATR, do not trail
      document.getElementById('tp2Box').innerHTML = `
        <div style="font-size:10px;font-weight:800;color:#92400e;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'Rajdhani',sans-serif;">TP2 Â· 3Ã—ATR â€” RANGE EXIT (Take profit. Do not trail.)</div>
        <div style="font-size:20px;font-weight:900;color:#92400e;margin-bottom:4px;font-family:'JetBrains Mono',monospace;">${tp2Price}</div>
        <div style="font-size:12px;font-weight:700;color:#92400e;font-family:'JetBrains Mono',monospace;">${tp2Pips.toFixed(1)} pips Â· +$${tp2Prof.toFixed(2)} Â· RR ${rr2}:1</div>`;
    } else {
      // Trend: 3xATR partial exit, then trail SAR â€” same on ALL timeframes and instruments
      document.getElementById('tp2Box').innerHTML = `
        <div style="font-size:10px;font-weight:800;color:#2563eb;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'Rajdhani',sans-serif;">TP2 Â· 3Ã—ATR â€” Partial Exit. Then Trail SAR.</div>
        <div style="font-size:20px;font-weight:900;color:#1d4ed8;margin-bottom:4px;font-family:'JetBrains Mono',monospace;">${tp2Price}</div>
        <div style="font-size:12px;font-weight:700;color:#2563eb;font-family:'JetBrains Mono',monospace;">${tp2Pips.toFixed(1)} units Â· +$${tp2Prof.toFixed(2)} Â· RR ${rr2}:1</div>
        <div style="margin-top:10px;padding:12px 14px;background:#0f172a;border-radius:10px;border:1.5px solid #3b82f6;">
          <div style="font-size:11px;font-weight:800;color:#60a5fa;letter-spacing:1px;margin-bottom:8px;font-family:'Rajdhani',sans-serif;">ðŸ” TRAILING STOP â€” SAR METHOD (All Timeframes Â· All Instruments)</div>
          <div style="font-size:12px;font-weight:700;color:#e2e8f0;font-family:'JetBrains Mono',monospace;line-height:1.9;">
            Step 1 â€” At TP1 (2Ã—ATR): Close partial position. Move SL to breakeven.<br>
            Step 2 â€” At TP2 (3Ã—ATR): Close partial position. Let remainder run free.<br>
            Step 3 â€” TRAIL: Follow SAR value as it moves with price every candle.<br>
            Step 4 â€” EXIT: Only when SAR flips direction. Not before.<br>
            Rule â€” ADX still rising = trend intact = hold. Do not exit early.
          </div>
        </div>`;
    }

    // Notes â€” only show JPY note if applicable. No SL width warnings â€” SAR is always correct.
    let levNotes = '';
    if (cfg.jpy) levNotes += `<div style="padding:10px 14px;background:#eff6ff;border:1.5px solid #93c5fd;border-radius:10px;margin-top:10px;font-size:12px;font-weight:700;color:#1d4ed8;font-family:'JetBrains Mono',monospace;">âš¡ JPY pair â€” pip at 0.01 (2nd decimal). All calculations are correct for this instrument.</div>`;
    document.getElementById('levelsNotes').innerHTML = levNotes;

    } // end sarWrongSide else

    // â”€â”€ STATS â”€â”€
    const marginRisk = free < slLoss;
    const riskColor  = +riskPct > 10 ? '#dc2626' : +riskPct > 5 ? '#d97706' : '#16a34a';
    const rrColor    = +rr1 >= 2 ? '#16a34a' : '#d97706';
    const freeColor  = marginRisk ? '#dc2626' : '#16a34a';
    const stats = [
      {lbl:'Market Mode', val: mode==='RANGE'?'RANGE':mode==='NOmans'?'NO MANS':'TREND',
       color: mode==='RANGE'?'#92400e':mode==='NOmans'?'#6b7280':'#16a34a'},
      {lbl:'Risk %',      val: riskPct+'%',        color: riskColor},
      {lbl:'RR (TP1)',    val: rr1+' : 1',          color: rrColor},
      {lbl:'Pip Value',   val: '$'+pv.toFixed(3),   color:'#111'},
      {lbl:'SL = SAR',    val: fmt(sar),             color:'#dc2626'},
      {lbl:'Margin Used', val: '$'+margin.toFixed(2),color:'#111'},
      {lbl:'Free Margin', val: '$'+free.toFixed(2), color: freeColor},
    ];
    document.getElementById('statsGrid').style.gridTemplateColumns = '1fr 1fr';
    document.getElementById('statsGrid').innerHTML = stats.map(s =>
      `<div class="calc-stat">
        <div style="font-size:10px;font-weight:800;color:#9ca3af;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'Rajdhani',sans-serif;">${s.lbl}</div>
        <div style="font-size:14px;font-weight:900;color:${s.color};font-family:'JetBrains Mono',monospace;">${s.val}</div>
      </div>`
    ).join('');
    // â”€â”€ REAL MARGIN CALL CHECK â”€â”€
    // Leverage lets you open the trade but your free margin must survive
    // the full drawdown from entry to SAR. If it cannot â€” broker closes early.
    const requiredFreeMargin = slLoss;           // need this much free margin to hold to SAR
    const actualFreeMargin   = balance - margin;  // what is actually available after opening
    const realMarginRisk     = actualFreeMargin < requiredFreeMargin;
    const unitsBeforeMC      = actualFreeMargin / (pv / pm); // price units before margin call

    let statsNote = '';
    if (realMarginRisk) {
      statsNote += `<div style="padding:12px 14px;background:#7f1d1d;border:2px solid #ef4444;border-radius:12px;margin-top:8px;">
        <div style="font-size:12px;font-weight:900;color:#fecaca;font-family:'Rajdhani',sans-serif;margin-bottom:6px;">â›” MARGIN CALL BEFORE SAR IS REACHED</div>
        <div style="font-size:11px;font-weight:700;color:#fca5a5;font-family:'JetBrains Mono',monospace;line-height:1.8;">
          Your leverage opens the trade â€” but your free margin ($${actualFreeMargin.toFixed(2)}) cannot absorb the full SAR drawdown ($${requiredFreeMargin.toFixed(2)}).<br>
          Broker will close you at approximately ${unitsBeforeMC.toFixed(1)} units of adverse move.<br>
          Your SAR stop is ${slPips.toFixed(1)} units away â€” you will never reach it.<br>
          Required balance to hold to SAR: $${(margin + requiredFreeMargin).toFixed(2)}<br>
          Solution: Reduce lot size or increase account balance.
        </div>
      </div>`;
    }
    if (+riskPct > 10 && !realMarginRisk) {
      statsNote += `<div style="padding:10px 14px;background:#fff7ed;border:1.5px solid #fb923c;border-radius:10px;margin-top:8px;font-size:12px;font-weight:700;color:#9a3412;font-family:'JetBrains Mono',monospace;">âš ï¸ Risk ${riskPct}% is high. Proper Wilder money management = 1-2% risk per trade. Reduce lot size.</div>`;
    }
    if (slPips > atrPips * 2 && mode === 'TREND') {
      statsNote += `<div style="padding:10px 14px;background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px;margin-top:8px;font-size:12px;font-weight:700;color:#15803d;font-family:'JetBrains Mono',monospace;">â„¹ï¸ SAR is wider than 2Ã—ATR â€” RR at TP1 is ${rr1}:1. This is correct. The real return is in the SAR trail, not TP1. Hold until SAR flips.</div>`;
    }
    document.getElementById('statsNotes').innerHTML = statsNote;
  }

  // â”€â”€ UPDATE sendToCalculator to use internal tab instead of opening URL â”€â”€
  function sendToCalculator() {
    const pair = document.getElementById('f_pair').value.trim();
    const entry = document.getElementById('f_entry').value.trim();
    if (!pair || !entry) { toast('âš  Scan a chart first'); return; }
    fillCalcFromScan();
  }

  // Init calculator on load
  window.addEventListener('DOMContentLoaded', initCalc);

</script>
</body>
</html>
